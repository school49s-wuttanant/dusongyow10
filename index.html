<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกข้อความฝ่ายบุคคล</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f7ff; }
        .form-card { box-shadow: 0 4px 20px rgba(30, 64, 175, 0.08); border: 1px solid #e0e7ff; }
        .table-container { overflow-x: auto; }
        .edit-mode-active { border: 2px solid #2563eb; background-color: #f8faff; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #bfdbfe; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #3b82f6; }

        .search-input {
            transition: all 0.3s;
            border: 1px solid #cbd5e1;
        }
        .search-input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
            background-color: white;
        }
        .header-gradient {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-10 p-8 rounded-3xl header-gradient shadow-lg shadow-blue-200">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">ระบบบันทึกข้อความฝ่ายบุคคล</h1>
            <p class="text-blue-100 text-lg opacity-90">โรงเรียนบ้านดุซงยอ</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Form Section (1/4) -->
            <div class="lg:col-span-1">
                <div id="formContainer" class="bg-white rounded-2xl p-6 form-card sticky top-8 transition-all duration-300">
                    <div class="flex justify-between items-center mb-6 border-b border-blue-50 pb-3">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-6 bg-blue-600 rounded-full"></div>
                            <h2 id="formTitle" class="text-xl font-bold text-slate-800">ลงทะเบียนใหม่</h2>
                        </div>
                        <button id="cancelEditBtn" class="hidden text-sm text-red-500 hover:text-red-700 font-medium">ยกเลิก</button>
                    </div>
                    
                    <form id="memoForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-600 mb-1">เลขที่บันทึก</label>
                            <input type="text" id="memoId" name="memoId" readonly
                                class="w-full px-4 py-2 bg-blue-50 border border-blue-100 rounded-xl text-blue-700 font-bold outline-none">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-slate-600 mb-1">ลงวันที่ <span class="text-red-500">*</span></label>
                            <input type="date" id="dateInput" class="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none mb-2">
                            <input type="text" id="displayDate" readonly class="w-full px-4 py-2 bg-slate-50 border border-slate-100 rounded-xl text-slate-500 text-sm outline-none">
                            <input type="hidden" id="fullDateFormatted" name="date">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-slate-600 mb-1">เรื่อง <span class="text-red-500">*</span></label>
                            <input type="text" id="subject" name="subject" required class="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none placeholder:text-slate-300" placeholder="ระบุชื่อเรื่อง...">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-slate-600 mb-1">ผู้รับผิดชอบ <span class="text-red-500">*</span></label>
                            <input type="text" id="responsible" name="responsible" required class="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none placeholder:text-slate-300" placeholder="ชื่อ-นามสกุล...">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-slate-600 mb-1">หมายเหตุ</label>
                            <textarea id="note" name="note" rows="2" class="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none placeholder:text-slate-300" placeholder="ข้อมูลเพิ่มเติม (ถ้ามี)"></textarea>
                        </div>

                        <div id="statusMsg" class="hidden p-3 rounded-xl text-center text-sm font-medium"></div>

                        <button type="submit" id="submitBtn" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-3.5 px-6 rounded-xl shadow-lg shadow-blue-100 transition-all active:scale-[0.98] mt-2">
                            บันทึกข้อมูล
                        </button>
                    </form>
                </div>
            </div>

            <!-- Table Section (3/4) -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-3xl p-6 form-card min-h-[550px] relative border border-blue-50">
                    <div id="tableLoader" class="loading-overlay absolute inset-0 rounded-3xl hidden flex items-center justify-center bg-white/80 z-20">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-100 border-t-blue-600"></div>
                    </div>

                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                        <div class="flex items-center space-x-3">
                            <div class="p-2 bg-blue-600 rounded-lg shadow-blue-200 shadow-md">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-slate-800">รายการที่บันทึกแล้ว</h2>
                                <p class="text-xs text-slate-400">ข้อมูลทั้งหมดในระบบ</p>
                            </div>
                            <span id="recordCount" class="bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold tracking-wider ml-2">0</span>
                        </div>
                        
                        <!-- ช่องค้นหาข้อมูล -->
                        <div class="relative w-full md:w-80">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3.5">
                                <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            </span>
                            <input type="text" id="searchInput" placeholder="ค้นหาเลขที่, เรื่อง, หรือผู้รับผิดชอบ..." 
                                class="search-input w-full pl-11 pr-4 py-2.5 rounded-2xl text-sm outline-none bg-blue-50/50">
                        </div>
                    </div>

                    <div class="table-container rounded-2xl border border-blue-50">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-blue-600 text-white">
                                    <th class="px-5 py-4 text-xs font-bold uppercase tracking-wider w-[15%] rounded-tl-2xl">เลขที่</th>
                                    <th class="px-5 py-4 text-xs font-bold uppercase tracking-wider w-[20%]">วันที่</th>
                                    <th class="px-5 py-4 text-xs font-bold uppercase tracking-wider w-[30%]">เรื่อง</th>
                                    <th class="px-5 py-4 text-xs font-bold uppercase tracking-wider w-[25%]">ผู้รับผิดชอบ</th>
                                    <th class="px-5 py-4 text-xs font-bold uppercase tracking-wider text-center w-[10%] rounded-tr-2xl">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="memoList" class="divide-y divide-blue-50 text-sm"></tbody>
                        </table>
                    </div>
                    <div id="emptyState" class="hidden text-center py-24 text-slate-400">
                        <div class="mb-4 flex justify-center opacity-20">
                            <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg>
                        </div>
                        <p class="text-lg">ไม่พบข้อมูลที่ค้นหา</p>
                        <p class="text-sm">ลองค้นหาด้วยคำอื่นหรือตรวจสอบการสะกด</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-16 mb-12 text-center">
            <div class="inline-block px-6 py-2 bg-blue-100/50 rounded-full border border-blue-200">
                <p class="text-blue-700 font-medium text-sm">จัดทำโดย นายวุฒนันท์ เจ๊ะดาโอะ</p>
            </div>
            <p class="mt-4 text-slate-400 text-[10px] uppercase tracking-[0.2em]">© 2026 HR Memo Registry System</p>
        </div>
    </div>

    <script>
        const START_YEAR = 2569;
        const PREFIX = "บค.";
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzSP9aNIza-XxhLnpXzD0Ud7b3gkFen8Naqt6bChTEkLTisVeqd-dqEWPa7zahChtPgkw/exec";

        let currentRecords = [];
        let isEditMode = false;

        function formatThaiDate(dateObj) {
            const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            return `${dateObj.getDate()} ${months[dateObj.getMonth()]} ${dateObj.getFullYear() + 543}`;
        }

        async function fetchDataFromSheet() {
            document.getElementById('tableLoader').classList.remove('hidden');
            try {
                const response = await fetch(WEB_APP_URL);
                currentRecords = await response.json();
                filterAndRender();
                if (!isEditMode) updateNextMemoId();
            } catch (error) {
                console.error("Fetch error:", error);
                showStatus("ไม่สามารถเชื่อมต่อฐานข้อมูลได้", "error");
            } finally {
                document.getElementById('tableLoader').classList.add('hidden');
            }
        }

        function updateNextMemoId() {
            let maxNum = 0;
            currentRecords.forEach(rec => {
                if (rec.memoId && rec.memoId.includes('/')) {
                    const numPart = rec.memoId.split('/')[0].replace(PREFIX, '');
                    const num = parseInt(numPart);
                    if (!isNaN(num) && num > maxNum) maxNum = num;
                }
            });
            document.getElementById('memoId').value = `${PREFIX}${maxNum + 1}/${START_YEAR}`;
        }

        function filterAndRender() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = currentRecords.filter(item => {
                return (
                    (item.memoId && item.memoId.toLowerCase().includes(searchTerm)) ||
                    (item.subject && item.subject.toLowerCase().includes(searchTerm)) ||
                    (item.responsible && item.responsible.toLowerCase().includes(searchTerm)) ||
                    (item.date && item.date.toLowerCase().includes(searchTerm))
                );
            });
            renderTable(filtered);
        }

        function renderTable(records) {
            const listBody = document.getElementById('memoList');
            document.getElementById('recordCount').innerText = records.length;
            listBody.innerHTML = '';

            if (records.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
            } else {
                document.getElementById('emptyState').classList.add('hidden');
                [...records].reverse().forEach(item => {
                    const row = `
                        <tr class="hover:bg-blue-50 transition-colors border-b border-blue-50 last:border-0">
                            <td class="px-5 py-4 font-bold text-blue-700">${item.memoId}</td>
                            <td class="px-5 py-4 text-slate-500 font-light">${cleanDateDisplay(item.date)}</td>
                            <td class="px-5 py-4 text-slate-700 font-medium">${item.subject}</td>
                            <td class="px-5 py-4 text-slate-600">
                                <span class="px-2 py-1 bg-blue-100/50 rounded-lg text-xs font-semibold text-blue-600">${item.responsible || '-'}</span>
                            </td>
                            <td class="px-5 py-4 text-center">
                                <button onclick="startEdit('${item.memoId}')" class="bg-white text-blue-600 border border-blue-200 hover:bg-blue-600 hover:text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-all shadow-sm">
                                    แก้ไข
                                </button>
                            </td>
                        </tr>
                    `;
                    listBody.insertAdjacentHTML('beforeend', row);
                });
            }
        }

        function cleanDateDisplay(dateVal) {
            if (!dateVal) return "-";
            if (typeof dateVal === 'string' && dateVal.includes('T')) {
                const datePart = dateVal.split('T')[0];
                const p = datePart.split('-');
                const y = parseInt(p[0]);
                const d = new Date(y > 2500 ? y - 543 : y, parseInt(p[1]) - 1, parseInt(p[2]));
                return formatThaiDate(d);
            }
            return dateVal;
        }

        document.getElementById('searchInput').addEventListener('input', filterAndRender);

        function startEdit(memoId) {
            const record = currentRecords.find(r => r.memoId === memoId);
            if (!record) return;

            isEditMode = true;
            document.getElementById('formTitle').innerText = "แก้ไขข้อมูล";
            document.getElementById('formContainer').classList.add('edit-mode-active', 'shadow-2xl', 'shadow-blue-200');
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            document.getElementById('submitBtn').innerText = "บันทึกการแก้ไข";
            document.getElementById('submitBtn').classList.replace('bg-blue-700', 'bg-blue-600');

            document.getElementById('memoId').value = record.memoId;
            document.getElementById('subject').value = record.subject;
            document.getElementById('responsible').value = record.responsible;
            document.getElementById('note').value = record.note || '';
            
            document.getElementById('displayDate').value = record.date;
            document.getElementById('fullDateFormatted').value = record.date;

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        document.getElementById('cancelEditBtn').onclick = () => {
            isEditMode = false;
            document.getElementById('memoForm').reset();
            document.getElementById('formTitle').innerText = "ลงทะเบียนใหม่";
            document.getElementById('formContainer').classList.remove('edit-mode-active', 'shadow-2xl', 'shadow-blue-200');
            document.getElementById('cancelEditBtn').classList.add('hidden');
            document.getElementById('submitBtn').innerText = "บันทึกข้อมูล";
            document.getElementById('submitBtn').classList.replace('bg-blue-600', 'bg-blue-700');
            setCurrentDate();
            updateNextMemoId();
        };

        const dateInput = document.getElementById('dateInput');
        const displayDate = document.getElementById('displayDate');
        const fullDateFormatted = document.getElementById('fullDateFormatted');

        function setCurrentDate() {
            const now = new Date();
            dateInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            const thai = formatThaiDate(now);
            displayDate.value = thai;
            fullDateFormatted.value = thai;
        }

        dateInput.addEventListener('change', (e) => {
            const d = new Date(e.target.value);
            if (!isNaN(d.getTime())) {
                const thai = formatThaiDate(d);
                displayDate.value = thai;
                fullDateFormatted.value = thai;
            }
        });

        window.onload = () => {
            setCurrentDate();
            fetchDataFromSheet();
        };

        document.getElementById('memoForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "กำลังประมวลผล...";
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(data)
                });

                showStatus(isEditMode ? "ปรับปรุงข้อมูลสำเร็จ" : "บันทึกข้อมูลเรียบร้อย", "success");
                
                setTimeout(() => {
                    if (isEditMode) {
                        document.getElementById('cancelEditBtn').click();
                    } else {
                        e.target.reset();
                        setCurrentDate();
                    }
                    fetchDataFromSheet();
                    btn.disabled = false;
                    document.getElementById('statusMsg').classList.add('hidden');
                }, 1000);

            } catch (error) {
                showStatus("เกิดข้อผิดพลาดในการบันทึก", "error");
                btn.disabled = false;
                btn.innerText = "ลองอีกครั้ง";
            }
        };

        function showStatus(msg, type) {
            const s = document.getElementById('statusMsg');
            s.innerText = msg;
            s.classList.remove('hidden', 'bg-emerald-50', 'text-emerald-700', 'bg-rose-50', 'text-rose-700');
            if (type === "success") {
                s.classList.add('bg-emerald-50', 'text-emerald-700', 'border', 'border-emerald-100');
            } else {
                s.classList.add('bg-rose-50', 'text-rose-700', 'border', 'border-rose-100');
            }
        }
    </script>
</body>
</html>